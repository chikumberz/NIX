/**
 * plugin.js
 *
 * Copyright, Benjamin Taluyo
 */

tinymce.PluginManager.add( 'filemanager_tool', function ( editor ) {

	function filemanager_tool_onMessage ( event ){
		if ( editor.settings.filemanager_path.toLowerCase( ).indexOf( event.origin.toLowerCase( ) ) === 0 ) {
			if ( event.data.sender === 'filemanager' ) {
				tinymce.activeEditor.insertContent( event.data.html );
				tinymce.activeEditor.windowManager.close( );

				// Remove event listener for a message from ResponsiveFilemanager
				if ( window.removeEventListener ) {
					window.removeEventListener( 'message', filemanager_tool_onMessage, false );
				} else {
					window.detachEvent( 'onmessage', filemanager_tool_onMessage );
				}
			}
		}
	}

	function openmanager ( ) {

		var width  = window.innerWidth - 30;
		var height = window.innerHeight - 60;

		if ( width > 1800 ) width  = 1800;
		if (height > 1200 ) height = 1200;

		var width_reduce = ( width - 20 ) % 138;
		width = width - width_reduce + 10;

		if ( width > 600 ) {
			var width_reduce = ( width - 20 ) % 138;
			width = width - width_reduce + 10;
		}

		editor.focus( true );
		var title = 'File Manager';

		if ( typeof editor.settings.filemanager_title !== 'undefined' && editor.settings.filemanager_title ) {
			title = editor.settings.filemanager_title;
		}

		var sort_by = '';

		if ( typeof editor.settings.filemanager_sort_by !== 'undefined' && editor.settings.filemanager_sort_by ) {
			sort_by = '&sort_by=' + editor.settings.filemanager_sort_by;
		}
		var sort_order = 0;

		if ( typeof editor.settings.filemanager_sort_order !== 'undefined' && editor.settings.filemanager_sort_order ) {
			sort_order = '&sort_order=' + editor.settings.filemanager_sort_order;
		}

		var fldr = '';

		if ( typeof editor.settings.filemanager_folder !== 'undefined' && editor.settings.filemanager_folder ) {
			fldr = '&fldr=' + editor.settings.filemanager_folder;
		}

		var crossdomain = '';

		if ( typeof editor.settings.filemanager_crossdomain !== 'undefined' && editor.settings.filemanager_crossdomain ) {
			crossdomain = '&crossdomain=1';

			// Add handler for a message from ResponsiveFilemanager
			if( window.addEventListener ){
				window.addEventListener( 'message', filemanager_onMessage, false );
			} else {
				window.attachEvent( 'onmessage', filemanager_onMessage );
			}
		}

		win = editor.windowManager.open({
			title: title,
			file: editor.settings.filemanager_path + '?popup=1&type=4' + sort_order + sort_by + fldr + crossdomain,
			width: width,
			height: height,
			inline: 1,
			resizable: true,
			maximizable: true
		});
	}

	editor.addButton( 'filemanager_tool', {
		icon: 'browse',
		tooltip: 'Insert file',
		shortcut: 'Ctrl+E',
        onclick: openmanager
	});

	editor.addShortcut( 'Ctrl+E', '', openmanager );

	editor.addMenuItem( 'filemanager_tool', {
		icon: 'browse',
		text: 'Insert file',
		shortcut: 'Ctrl+E',
		onclick: openmanager,
		context: 'insert'
	});

});